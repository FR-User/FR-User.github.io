<html>
    <head>
        <title>모동숲 해산물 가격표</title>
        <script src="./list.min.js"></script>
        <script>

            let userList = null;

            const root = document.documentElement;

            window.onload = async ()=>{
                try{

                    const result = await fetchData("https://fr-user.github.io/acSeaFoodListing/data.csv");

                    const splitted_result = result.split("\n")

                    const index = splitted_result[0].replaceAll(" ", "_").trim().split(",");
                    const rows = splitted_result.slice(1);

                    makeSortBtns(index);
                    insertRows(rows, index);

                    userList = new List('users', {
                        valueNames: index
                    });
                }catch(error){
                    console.error(error);
                }

            }

            const filechanged = async (event)=>{
                try{
                    const file = event.target.files[0];

                    if(!file){
                        return false;
                    }

                    const table = document.querySelector("table>tbody.list");
                    const index_table = document.querySelector("table>thead>tr#sortbtns");
                    table.innerHTML = '';
                    index_table.innerHTML = '';

                    


                    const objectURL = URL.createObjectURL(file);

                    const result = await fetchData(objectURL);

                    const splitted_result = result.split("\n")

                    const index = splitted_result[0].replaceAll(" ", "_").trim().split(",");
                    const rows = splitted_result.slice(1);

                    makeSortBtns(index);
                    insertRows(rows, index);

                    userList = new List('users', {
                        valueNames: index
                    });
                }catch(error){
                    console.error(error);
                }

            }

            const makeSortBtns = (index)=>{

                if(index.length < 1){
                    throw new Error("입력이 배열이 아님");
                }

                const btn_holder = document.querySelector("table>thead>tr#sortbtns");
                if((btn_holder === undefined) || (btn_holder === null)){
                    throw new Error("버튼이 들어갈 공간이 없음");
                }

                index.forEach(element=>{
                    const btn_col = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.classList.add("sort");
                    btn.innerHTML = element.replaceAll("_", " ");
                    btn.setAttribute("data-sort", element);

                    btn_col.appendChild(btn);
                    btn_holder.appendChild(btn_col);

                    //btn_holder.appendChild(btn);
                });
            }

            const insertRows = (rows, index_table)=>{
                if(rows.lenght < 1){
                    throw new Error("입력이 배열이 아님");
                }

                const table_holder = document.querySelector("table>tbody.list");

                if((table_holder === undefined) || (table_holder === null)){
                    throw new Error("리스트가 들어갈 공간이 없음");
                }

                rows.forEach(row=>{
                    const row_html = document.createElement('tr');
                    
                    let cur_name = "";

                    row.split(",").forEach((column,index)=>{
                        const column_html = document.createElement('td');

                        if(index_table[index] == "이름"){
                            cur_name = column;
                            //const img = document.createElement('img');
                            //img.src = `./src/${}`
                        }

                        column_html.classList.add(index_table[index]);

                        if(index_table[index] == "이미지"){
                            const img = document.createElement('img');
                            img.src = `./src/${cur_name}.png`;
                            column_html.appendChild(img);
                        }else{
                            const span = document.createElement('span');
                            span.textContent = column;
                            column_html.appendChild(span);
                        }


                        row_html.appendChild(column_html);
                    });

                    table_holder.appendChild(row_html);
                });
            }

            const fetchData = async (url)=>{

                try{
                    const response = await fetch(url);

                    if(!response.ok){
                        throw new Error(`HTTP Error : ${response.status}`);
                    }

                    const data = await response.text();

                    return data;
                }catch(error){
                    console.error('an error occured on processing : ', error);
                }

            }

            const imgSizeChange = (event)=>{
                root.style.setProperty('--img-size', event.target.value+'px');
            }

        </script>

        <style>
            :root{
                --img-size: 20px;
                --text-margin: 20px;

                --border-style: 1px solid black;
            }
            img{
                width: var(--img-size);
                height: var(--img-size);
            }
            button{
                width: -webkit-fill-available;
            }
            table{
                border-collapse: collapse;
            }
            td{
                border-left: var(--border-style);
            }
            td.이미지{
                text-align: center;
            }
            td:last-child{
                border-right: var(--border-style)
            }
            td > span{
                padding-left: var(--text-margin);
                padding-right: var(--text-margin);
            }
            tr:nth-child(odd){
                background-color: #19ff001a;
            }
        </style>
    </head>
    <body>
        <input type="file" onchange="filechanged(event)">
        <div id="users">
            <div style="display: flex;">
                <input class="search" placeholder="Search" />
                <input type="number" placeholder="사진 크기" value="20" onchange="imgSizeChange(event)"/>
            </div>

            <table>
                <thead>
                    <tr id="sortbtns">
                    </tr>
                </thead>
                <tbody class="list">
                </tbody>
            </table>
        </div>
    </body>
</html>